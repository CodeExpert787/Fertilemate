<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>User Management - Fertilemate</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      padding:20px;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #2d3748;
      line-height: 1.6;
      padding: 2rem 1rem;
    }

    .navbar {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      color: #2d3748;
      padding: 1.2rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
      border-bottom: 1px solid rgba(255, 255, 255, 0.18);
      position: fixed; top: 0; left: 0; right: 0; z-index: 1000;
    }
    .navbar .logo {
      font-size: 1.8rem; font-weight: 700;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
      letter-spacing: -0.5px;
    }
    .navbar nav a {
      color: #4a5568; text-decoration: none; margin-left: 2rem; font-size: 0.95rem; font-weight: 500; padding: 0.5rem 1rem; border-radius: 8px; transition: all 0.3s ease;
    }
    .navbar nav a:hover { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; transform: translateY(-1px); }

    .container {
      max-width: full; margin: 8rem auto 2.5rem; background: rgba(255, 255, 255, 0.97);
      backdrop-filter: blur(20px); border-radius: 24px; box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
      border: 1px solid rgba(255, 255, 255, 0.18); padding: 2rem;
    }

    .page-title {
      font-size: 2.2rem; font-weight: 700; text-align: center; margin-bottom: 1.5rem;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
    }

    .flash {
      margin: 0 auto 1rem; max-width: 900px; display: grid; gap: 0.5rem;
    }
    .flash .msg { padding: 0.8rem 1rem; border-radius: 10px; font-weight: 500; }
    .flash .success { background: rgba(16, 185, 129, 0.12); color: #065f46; border: 1px solid rgba(16, 185, 129, 0.25); }
    .flash .danger { background: rgba(239, 68, 68, 0.12); color: #7f1d1d; border: 1px solid rgba(239, 68, 68, 0.25); }
    .flash .info { background: rgba(59, 130, 246, 0.12); color: #1e3a8a; border: 1px solid rgba(59, 130, 246, 0.25); }

    .card {
      background: rgba(255,255,255,0.9); border: 1px solid rgba(102,126,234,0.15);
      box-shadow: 0 10px 30px rgba(0,0,0,0.06); border-radius: 16px; padding: 1.2rem 1.2rem;
    }

    .section-title { font-size: 1.3rem; color: #667eea; margin-bottom: 1rem; font-weight: 700; letter-spacing: 0.5px; }

    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1rem; }
    label { display: block; font-weight: 600; margin-bottom: 0.35rem; color: #4a5568; }
    input, select {
      width: 100%; padding: 0.8rem 0.9rem; border: 2px solid rgba(102, 126, 234, 0.12);
      border-radius: 12px; font-size: 0.95rem; background: rgba(255,255,255,0.85);
      transition: all 0.2s ease; backdrop-filter: blur(10px);
    }
    input:focus, select:focus { outline: none; border-color: rgba(102,126,234,0.45); box-shadow: 0 0 0 3px rgba(102,126,234,0.15); }

    .actions { margin-top: 1rem; display: flex; gap: 0.75rem; justify-content: flex-end; }
    .btn {
      padding: 0.75rem 1.4rem; border: none; border-radius: 999px; font-size: 0.95rem; font-weight: 600;
      cursor: pointer; transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 0.4rem;
    }
    .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3); }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4); }
    .btn-danger { background: #dc2626; color: #fff; }
    .btn-danger:hover { background: #b91c1c; transform: translateY(-1px); }
    .btn-ghost { background: rgba(255,255,255,0.85); color: #4a5568; border: 2px solid rgba(102,126,234,0.2); }
    .btn-ghost:hover { background: rgba(102,126,234,0.08); }

    .table-container {
      margin-top: 1.5rem; background: rgba(255,255,255,0.9); border: 1px solid rgba(102,126,234,0.15);
      border-radius: 16px; overflow-x: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.06);
    }
    table { width: 100%; border-collapse: collapse; }
    thead th {
      background: linear-gradient(135deg, rgba(102,126,234,0.12) 0%, rgba(118,75,162,0.12) 100%);
      color: #1f2937; text-align: left; font-weight: 700; font-size: 0.9rem; letter-spacing: 0.01em; padding: 0.9rem 1rem; border-bottom: 1px solid rgba(102,126,234,0.2); position: sticky; top: 0; z-index: 1; white-space: nowrap;
    }
    tbody td { padding: 0.85rem 1rem; border-bottom: 1px solid rgba(102,126,234,0.12); vertical-align: middle; color: #374151; font-size: 0.95rem; }
    tbody tr:hover { background: rgba(102,126,234,0.06); }
    .muted { color: #6b7280; font-size: 0.9rem; }
    .action-row { display: flex; gap: 0.5rem; align-items: center; flex-wrap: nowrap; }

    .toolbar {
      display: grid; grid-template-columns: 1fr repeat(3, minmax(180px, 220px)); gap: 0.8rem; align-items: center;
      margin: 1rem 0 0.5rem;
    }
    .toolbar input[type="text"], .toolbar select {
      padding: 0.7rem 0.9rem; border: 2px solid rgba(102,126,234,0.12); border-radius: 12px; background: rgba(255,255,255,0.9);
      font-size: 0.95rem; outline: none; transition: all 0.2s ease;
    }
    .toolbar input[type="text"]:focus, .toolbar select:focus { border-color: rgba(102,126,234,0.45); box-shadow: 0 0 0 3px rgba(102,126,234,0.15); }
    .toolbar .count { justify-self: start; font-weight: 600; color: #4a5568; display: none; }

    .pagination {
      display: flex; gap: 0.4rem; align-items: center; justify-content: center; margin: 0.8rem 0 0.5rem; flex-wrap: wrap;
    }
    .page-btn {
      padding: 0.5rem 0.9rem; border-radius: 10px; border: 1px solid rgba(102,126,234,0.2); background: rgba(255,255,255,0.9);
      cursor: pointer; font-weight: 600; color: #4a5568;
    }
    .page-btn:hover { background: rgba(102,126,234,0.08); }
    .page-btn.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-color: transparent; }
    .page-btn:disabled { opacity: 0.5; cursor: not-allowed; }

    @media (max-width: 768px) {
      .navbar { padding: 1rem 1.5rem; }
      .container { margin: 6rem 1rem 2rem; padding: 1.25rem; }
      .page-title { font-size: 1.8rem; }
      .actions { justify-content: center; }
    }
  </style>
</head>
<body>
    <div class="navbar">
      <div class="logo">Fertilemate</div>
      <nav>
        <a href="/">Dashboard</a>
      </nav>
  </div>

    <div class="container">
      <h1 class="page-title">ðŸ‘¤ User Management</h1>

      <div class="flash">
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
              <div class="msg {{ category }}">{{ message }}</div>
      {% endfor %}
    {% endif %}
  {% endwith %}
      </div>

      <div class="card">
        <div class="section-title">Create New User</div>
      <form method="post" action="{{ url_for('admin_create_user') }}">
        <div class="grid">
          <div>
            <label for="new_username">Username</label>
            <input id="new_username" name="username" required />
          </div>
          <div>
            <label for="new_email">Email</label>
            <input id="new_email" type="email" name="email" required />
          </div>
          <div>
            <label for="new_role">Role</label>
            <select id="new_role" name="role">
              <option value="user">user</option>
              <option value="admin">admin</option>
            </select>
          </div>
          <div>
            <label for="new_password">Password</label>
            <input id="new_password" type="password" name="password" required />
          </div>
        </div>
          <div class="actions">
            <button class="btn btn-primary" type="submit">Create User</button>
        </div>
      </form>
    </div>

      <div class="section-title" style="margin-top: 1.5rem;">All Users</div>
      <div class="toolbar">
        <input id="userSearchInput" type="text" placeholder="Search username or email..." aria-label="Search users" />
        <select id="roleFilter" aria-label="Filter by role">
          <option value="">All roles</option>
          <option value="admin">Admin</option>
          <option value="user">User</option>
        </select>
        <select id="sortSelect" aria-label="Sort users">
          <option value="created_desc">Newest</option>
          <option value="created_asc">Oldest</option>
          <option value="username_asc">Username Aâ€“Z</option>
          <option value="username_desc">Username Zâ€“A</option>
          <option value="email_asc">Email Aâ€“Z</option>
          <option value="email_desc">Email Zâ€“A</option>
          <option value="role_asc">Role Aâ€“Z</option>
          <option value="role_desc">Role Zâ€“A</option>
        </select>
        <select id="pageSizeSelect" aria-label="Rows per page">
          <option value="10">10 per page</option>
          <option value="20">20 per page</option>
          <option value="50">50 per page</option>
          <option value="100">100 per page</option>
          <option value="all">Show all</option>
        </select>
        <div id="resultCount" class="count"></div>
  </div>
      <div class="table-container">
  <table>
    <thead>
      <tr>
        <th>ID</th>
        <th>Username</th>
        <th>Email</th>
        <th>Role</th>
        <th>Created</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for u in users %}
            <tr data-id="{{ u.id }}"
                data-username="{{ u.username|lower }}"
                data-email="{{ u.email|lower }}"
                data-role="{{ u.role|lower }}"
                data-created="{{ (u.created_at.isoformat() if u.created_at else '') }}">
        <td>{{ u.id }}</td>
        <td>
                <form class="inline-form" method="post" action="{{ url_for('admin_update_user', user_id=u.id) }}">
            <input name="username" value="{{ u.username }}" />
        </td>
        <td>
            <input type="email" name="email" value="{{ u.email }}" />
        </td>
        <td>
            <select name="role">
              <option value="user" {% if u.role == 'user' %}selected{% endif %}>user</option>
              <option value="admin" {% if u.role == 'admin' %}selected{% endif %}>admin</option>
            </select>
        </td>
        <td class="muted">{{ u.created_at.strftime('%Y-%m-%d %H:%M') if u.created_at else '' }}</td>
        <td>
                <div>
            <input type="password" name="password" placeholder="New password (optional)" />
                </div>
                <div class="action-row">
                    
          </form>
              <button class="btn btn-ghost" type="submit">Save</button>
          {% if u.id != session.get('user_id') %}
              <form class="inline-form" method="post" action="{{ url_for('admin_delete_user', user_id=u.id) }}" onsubmit="return confirm('Delete user {{ u.username }}?');" style="margin-top:0;">
                <button class="btn btn-danger" type="submit">Delete</button>
          </form>
          {% else %}
            <span class="muted">(You)</span>
          {% endif %}
              </div>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
      </div>
      <div id="pagination" class="pagination" aria-label="Users pagination"></div>
    </div>
    <script>
      (function() {
        const searchInput = document.getElementById('userSearchInput');
        const roleFilter = document.getElementById('roleFilter');
        const sortSelect = document.getElementById('sortSelect');
        const countEl = document.getElementById('resultCount');
        const pageSizeSelect = document.getElementById('pageSizeSelect');
        const pagination = document.getElementById('pagination');
        const tbody = document.querySelector('.table-container tbody');
        if (!tbody) return;
        const rows = Array.from(tbody.querySelectorAll('tr'));
        let currentPage = 1;
        let pageSize = 10;
        const MAX_BUTTONS = 7;

        function renderPagination(total, totalPages) {
          if (!pagination) return;
          pagination.innerHTML = '';
          if (totalPages <= 1) { pagination.style.display = 'none'; return; }
          pagination.style.display = '';

          const makeBtn = (label, page, disabled = false, active = false) => {
            const btn = document.createElement('button');
            btn.className = 'page-btn' + (active ? ' active' : '');
            btn.textContent = label;
            btn.disabled = disabled;
            btn.addEventListener('click', () => { if (!disabled) { currentPage = page; apply(); } });
            return btn;
          };

          // Prev
          pagination.appendChild(makeBtn('â€¹ Prev', Math.max(1, currentPage - 1), currentPage === 1));

          // Numbered buttons with windowing
          let start = Math.max(1, currentPage - Math.floor(MAX_BUTTONS / 2));
          let end = start + MAX_BUTTONS - 1;
          if (end > totalPages) { end = totalPages; start = Math.max(1, end - MAX_BUTTONS + 1); }

          if (start > 1) {
            pagination.appendChild(makeBtn('1', 1, false, currentPage === 1));
            if (start > 2) { const ell = document.createElement('span'); ell.textContent = 'â€¦'; ell.className = 'muted'; pagination.appendChild(ell); }
          }
          for (let p = start; p <= end; p++) pagination.appendChild(makeBtn(String(p), p, false, currentPage === p));
          if (end < totalPages) {
            if (end < totalPages - 1) { const ell = document.createElement('span'); ell.textContent = 'â€¦'; ell.className = 'muted'; pagination.appendChild(ell); }
            pagination.appendChild(makeBtn(String(totalPages), totalPages, false, currentPage === totalPages));
          }

          // Next
          pagination.appendChild(makeBtn('Next â€º', Math.min(totalPages, currentPage + 1), currentPage === totalPages));
        }

        function apply() {
          const term = (searchInput?.value || '').trim().toLowerCase();
          const role = (roleFilter?.value || '').toLowerCase();

          // Filter
          const filtered = rows.filter(row => {
            const uname = row.dataset.username || '';
            const email = row.dataset.email || '';
            const r = row.dataset.role || '';
            const matchesText = !term || uname.includes(term) || email.includes(term);
            const matchesRole = !role || r === role;
            return matchesText && matchesRole;
          });

          // Sort filtered rows
          const sortVal = sortSelect?.value || 'created_desc';
          const [key, dir] = sortVal.split('_');
          const asc = dir === 'asc';
          const cmp = (a, b) => asc ? (a < b ? -1 : a > b ? 1 : 0) : (a > b ? -1 : a < b ? 1 : 0);
          const getKey = (row) => {
            switch (key) {
              case 'username': return row.dataset.username || '';
              case 'email': return row.dataset.email || '';
              case 'role': return row.dataset.role || '';
              case 'created': {
                const iso = row.dataset.created || '';
                const t = iso ? Date.parse(iso) : 0;
                return isNaN(t) ? 0 : t;
              }
              default: return row.dataset.id ? parseInt(row.dataset.id, 10) || 0 : 0;
            }
          };
          const sorted = filtered.slice().sort((ra, rb) => cmp(getKey(ra), getKey(rb)));

          // Re-append in sorted order; visibility controlled by pagination
          tbody.innerHTML = '';
          sorted.forEach(r => tbody.appendChild(r));

          // Pagination
          const total = sorted.length;
          const psVal = pageSizeSelect?.value || '10';
          pageSize = (psVal === 'all') ? Number.MAX_SAFE_INTEGER : parseInt(psVal, 10) || 10;
          const totalPages = Math.max(1, Math.ceil(total / pageSize));
          if (currentPage > totalPages) currentPage = totalPages;
          const startIdx = (currentPage - 1) * pageSize;
          const endIdx = Math.min(startIdx + pageSize, total);

          // Hide all first
          rows.forEach(r => { r.style.display = 'none'; });
          // Show only current page slice
          for (let i = startIdx; i < endIdx; i++) sorted[i].style.display = '';

          // Update pagination UI
          renderPagination(total, totalPages);

          // Update count
          if (countEl) {
            countEl.style.display = '';
            countEl.textContent = `${total} user${total === 1 ? '' : 's'} â€” page ${currentPage} of ${totalPages}`;
          }
        }

        searchInput?.addEventListener('input', apply);
        roleFilter?.addEventListener('change', apply);
        sortSelect?.addEventListener('change', apply);
        pageSizeSelect?.addEventListener('change', () => { currentPage = 1; apply(); });
        // Initial run
        apply();
      })();
    </script>
</body>
</html>


